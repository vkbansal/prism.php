<p>Default language reference: <b>haskell</b></p>
<pre class="language-haskell"><code class="language-haskell"><span class="token hvariable">hGetLine</span> <span class="token hvariable">h</span> <span class="token operator">=</span>
  <span class="token hvariable">wantReadableHandle_</span> <span class="token string">"Data.ByteString.hGetLine"</span> <span class="token hvariable">h</span> <span class="token operator">$</span>
    <span class="token operator">\</span> <span class="token hvariable">h_</span><span class="token operator">@</span><span class="token constant">Handle__</span><span class="token punctuation">{</span><span class="token hvariable">haByteBuffer</span><span class="token punctuation">}</span> <span class="token operator">-&gt;</span> <span class="token keyword">do</span>
      <span class="token hvariable">flushCharReadBuffer</span> <span class="token hvariable">h_</span>
      <span class="token hvariable">buf</span> <span class="token operator">&lt;-</span> <span class="token hvariable">readIORef</span> <span class="token hvariable">haByteBuffer</span>
      <span class="token keyword">if</span> <span class="token hvariable">isEmptyBuffer</span> <span class="token hvariable">buf</span>
         <span class="token keyword">then</span> <span class="token hvariable">fill</span> <span class="token hvariable">h_</span> <span class="token hvariable">buf</span> <span class="token number">0</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
         <span class="token keyword">else</span> <span class="token hvariable">haveBuf</span> <span class="token hvariable">h_</span> <span class="token hvariable">buf</span> <span class="token number">0</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
 <span class="token keyword">where</span>

  <span class="token hvariable">fill</span> <span class="token hvariable">h_</span><span class="token operator">@</span><span class="token constant">Handle__</span><span class="token punctuation">{</span><span class="token hvariable">haByteBuffer</span><span class="token punctuation">,</span><span class="token hvariable">haDevice</span><span class="token punctuation">}</span> <span class="token hvariable">buf</span> <span class="token hvariable">len</span> <span class="token hvariable">xss</span> <span class="token operator">=</span>
    <span class="token hvariable">len</span> `<span class="token builtin">seq</span>` <span class="token keyword">do</span>
    <span class="token punctuation">(</span><span class="token hvariable">r</span><span class="token punctuation">,</span><span class="token hvariable">buf</span>'<span class="token punctuation">)</span> <span class="token operator">&lt;-</span> <span class="token hvariable">Buffered.fillReadBuffer</span> <span class="token hvariable">haDevice</span> <span class="token hvariable">buf</span>
    <span class="token keyword">if</span> <span class="token hvariable">r</span> <span class="token operator">==</span> <span class="token number">0</span>
       <span class="token keyword">then</span> <span class="token keyword">do</span> <span class="token hvariable">writeIORef</span> <span class="token hvariable">haByteBuffer</span> <span class="token hvariable">buf</span><span class="token punctuation">{</span> <span class="token hvariable">bufR</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token hvariable">bufL</span><span class="token operator">=</span><span class="token number">0</span> <span class="token punctuation">}</span>
               <span class="token keyword">if</span> <span class="token hvariable">len</span> <span class="token operator">&gt;</span> <span class="token number">0</span>
                  <span class="token keyword">then</span> <span class="token hvariable">mkBigPS</span> <span class="token hvariable">len</span> <span class="token hvariable">xss</span>
                  <span class="token keyword">else</span> <span class="token hvariable">ioe_EOF</span>
       <span class="token keyword">else</span> <span class="token hvariable">haveBuf</span> <span class="token hvariable">h_</span> <span class="token hvariable">buf</span>' <span class="token hvariable">len</span> <span class="token hvariable">xss</span>

  <span class="token hvariable">haveBuf</span> <span class="token hvariable">h_</span><span class="token operator">@</span><span class="token constant">Handle__</span><span class="token punctuation">{</span><span class="token hvariable">haByteBuffer</span><span class="token punctuation">}</span>
          <span class="token hvariable">buf</span><span class="token operator">@</span><span class="token constant">Buffer</span><span class="token punctuation">{</span> <span class="token hvariable">bufRaw</span><span class="token operator">=</span><span class="token hvariable">raw</span><span class="token punctuation">,</span> <span class="token hvariable">bufR</span><span class="token operator">=</span><span class="token hvariable">w</span><span class="token punctuation">,</span> <span class="token hvariable">bufL</span><span class="token operator">=</span><span class="token hvariable">r</span> <span class="token punctuation">}</span>
          <span class="token hvariable">len</span> <span class="token hvariable">xss</span> <span class="token operator">=</span>
    <span class="token keyword">do</span>
        <span class="token hvariable">off</span> <span class="token operator">&lt;-</span> <span class="token hvariable">findEOL</span> <span class="token hvariable">r</span> <span class="token hvariable">w</span> <span class="token hvariable">raw</span>
        <span class="token keyword">let</span> <span class="token hvariable">new_len</span> <span class="token operator">=</span> <span class="token hvariable">len</span> <span class="token operator">+</span> <span class="token hvariable">off</span> <span class="token operator">-</span> <span class="token hvariable">r</span>
        <span class="token hvariable">xs</span> <span class="token operator">&lt;-</span> <span class="token hvariable">mkPS</span> <span class="token hvariable">raw</span> <span class="token hvariable">r</span> <span class="token hvariable">off</span>

      <span class="token comment" spellcheck="true">-- if eol == True, then off is the offset of the '\n'
</span>      <span class="token comment" spellcheck="true">-- otherwise off == w and the buffer is now empty.
</span>        <span class="token keyword">if</span> <span class="token hvariable">off</span> /<span class="token operator">=</span> <span class="token hvariable">w</span>
            <span class="token keyword">then</span> <span class="token keyword">do</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token hvariable">w</span> <span class="token operator">==</span> <span class="token hvariable">off</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
                            <span class="token keyword">then</span> <span class="token hvariable">writeIORef</span> <span class="token hvariable">haByteBuffer</span> <span class="token hvariable">buf</span><span class="token punctuation">{</span> <span class="token hvariable">bufL</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token hvariable">bufR</span><span class="token operator">=</span><span class="token number">0</span> <span class="token punctuation">}</span>
                            <span class="token keyword">else</span> <span class="token hvariable">writeIORef</span> <span class="token hvariable">haByteBuffer</span> <span class="token hvariable">buf</span><span class="token punctuation">{</span> <span class="token hvariable">bufL</span> <span class="token operator">=</span> <span class="token hvariable">off</span> <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span>
                    <span class="token hvariable">mkBigPS</span> <span class="token hvariable">new_len</span> <span class="token punctuation">(</span><span class="token hvariable">xs</span><span class="token operator">:</span><span class="token hvariable">xss</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span> <span class="token keyword">do</span>
                 <span class="token hvariable">fill</span> <span class="token hvariable">h_</span> <span class="token hvariable">buf</span><span class="token punctuation">{</span> <span class="token hvariable">bufL</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token hvariable">bufR</span><span class="token operator">=</span><span class="token number">0</span> <span class="token punctuation">}</span> <span class="token hvariable">new_len</span> <span class="token punctuation">(</span><span class="token hvariable">xs</span><span class="token operator">:</span><span class="token hvariable">xss</span><span class="token punctuation">)</span>

  <span class="token comment" spellcheck="true">-- find the end-of-line character, if there is one
</span>  <span class="token hvariable">findEOL</span> <span class="token hvariable">r</span> <span class="token hvariable">w</span> <span class="token hvariable">raw</span>
        <span class="token operator">|</span> <span class="token hvariable">r</span> <span class="token operator">==</span> <span class="token hvariable">w</span> <span class="token operator">=</span> <span class="token builtin">return</span> <span class="token hvariable">w</span>
        <span class="token operator">|</span> <span class="token builtin">otherwise</span> <span class="token operator">=</span>  <span class="token keyword">do</span>
            <span class="token hvariable">c</span> <span class="token operator">&lt;-</span> <span class="token hvariable">readWord8Buf</span> <span class="token hvariable">raw</span> <span class="token hvariable">r</span>
            <span class="token keyword">if</span> <span class="token hvariable">c</span> <span class="token operator">==</span> <span class="token builtin">fromIntegral</span> <span class="token punctuation">(</span><span class="token builtin">ord</span> <span class="token char">'\n'</span><span class="token punctuation">)</span>
                <span class="token keyword">then</span> <span class="token builtin">return</span> <span class="token hvariable">r</span> <span class="token comment" spellcheck="true">-- NB. not r+1: don't include the '\n'
</span>                <span class="token keyword">else</span> <span class="token hvariable">findEOL</span> <span class="token punctuation">(</span><span class="token hvariable">r</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token hvariable">w</span> <span class="token hvariable">raw</span>

<span class="token hvariable">mkPS</span> <span class="token operator">::</span> <span class="token constant">RawBuffer</span> <span class="token constant">Word8</span> <span class="token operator">-&gt;</span> <span class="token constant">Int</span> <span class="token operator">-&gt;</span> <span class="token constant">Int</span> <span class="token operator">-&gt;</span> <span class="token constant">IO</span> <span class="token constant">ByteString</span>
<span class="token hvariable">mkPS</span> <span class="token hvariable">buf</span> <span class="token hvariable">start</span> <span class="token hvariable">end</span> <span class="token operator">=</span>
 <span class="token hvariable">create</span> <span class="token hvariable">len</span> <span class="token operator">$</span> <span class="token operator">\</span><span class="token hvariable">p</span> <span class="token operator">-&gt;</span>
   <span class="token hvariable">withRawBuffer</span> <span class="token hvariable">buf</span> <span class="token operator">$</span> <span class="token operator">\</span><span class="token hvariable">pbuf</span> <span class="token operator">-&gt;</span> <span class="token keyword">do</span>
   <span class="token hvariable">copyBytes</span> <span class="token hvariable">p</span> <span class="token punctuation">(</span><span class="token hvariable">pbuf</span> <span class="token operator">`plusPtr`</span> <span class="token hvariable">start</span><span class="token punctuation">)</span> <span class="token hvariable">len</span>
 <span class="token keyword">where</span>
   <span class="token hvariable">len</span> <span class="token operator">=</span> <span class="token hvariable">end</span> <span class="token operator">-</span> <span class="token hvariable">start</span>

</code></pre>
